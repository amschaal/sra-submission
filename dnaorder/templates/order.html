{% extends 'base.html' %}
{% load material_form %}
{% block content %}
<style>
.modal{
  width:90%;
  max-height:90%;
}
.bar {
    height: 18px;
    background: green;
}
#progress{
	display:none;
}
#files table td{
	padding: 5px;
}
.file-delete{
	cursor: pointer;
}
.toast.error{
background-color:#cc0000;
}
</style>
{% if submitted %}
<h3>Order {{order.id}} submitted! {% if editable %}<a class="btn right" href="{% url 'update_order' id=order.id %}">Modify</a>{% endif%}</h3>
<p>Communications regarding the order will be sent to {{order.email}}.  Please check your email and click the link to confirm the order.  To inquire on the status of the order, contact dnatech@ucdavis.edu.</p>
<p>You may now upload Bioanalyzer traces, or any other required files <a href="#files">below</a>.</p>
{% else %}
<h3>Order {{order.id}} {% if editable %}<a class="btn right" href="{% url 'update_order' id=order.id %}">Modify</a>{% endif%}</h3>
{% endif %}



<table>

{% if status_form %}
<tr>
	<th>Status</th>
	<td>
		<form id="status-form">
			{% form form=status_form %}{% part form.status label %}{% endpart %}{% endform %}
		</form>
	</td>
</tr>
{% else %}
<tr><th>Status</th><td>{{order.status.name}}</td></tr>
{% endif %}
<tr><th>Submitted</th><td>{{order.submitted}}</td></tr>
<tr><th>Updated</th><td>{{order.updated}}</td></tr>
<tr><th>Name</th><td>{{order.name}}</td></tr>
<tr><th>Email</th><td>{{order.email}}</td></tr>
<tr><th>Phone</th><td>{{order.phone}}</td></tr>
<tr><th>PI</th><td>{{order.pi_name}}</td></tr>
<tr><th>PI email</th><td>{{order.pi_email}}</td></tr>
<tr><th>Institute</th><td>{{order.institute}}</td></tr>
{% if order.notes %}<tr><th>Notes</th><td>{{order.notes}}</td></tr>{% endif %}
<tr><th>Type</th><td>{{order.type}}</td></tr>
<tr><th># Samples</th><td><span title="{% for s in order.sample_ids %}{{s}}{% if not forloop.last %}, {% endif %}{% endfor %}">{{order.sample_ids|length}}</span> </td></tr>
<tr>
	<th>Samplesheet</th>
	<td>
	<a id="view_samples" class="modal-trigger btn" href="#samples_modal">View</a>
  <!-- Dropdown Trigger -->
  <a class='dropdown-button btn' href='#' data-activates='download-samples'>Download</a>

  <!-- Dropdown Structure -->
  <ul id='download-samples' class='dropdown-content'>
    <li><a href="{% url 'download' id=order.id %}?data=samples&format=original">Original</a></li>
    <li><a href="{% url 'download' id=order.id %}?data=samples&format=csv">CSV</a></li>
    <li><a href="{% url 'download' id=order.id %}?data=samples&format=xlsx">XLSX</a></li>
    <!-- 
    <li><a href="#!">two</a></li>
    <li class="divider"></li>
    <li><a href="#!">three</a></li>
    <li><a href="#!"><i class="material-icons">view_module</i>four</a></li>
	 -->
  </ul>
	</td>
</tr>
{% if order.sra_form %}
<tr><th>SRA samplesheet</th>
	<td>
	<a id="view_sra" class="modal-trigger btn" href="#sra_modal">View</a>
	  <!-- Dropdown Trigger -->
	  <a class='dropdown-button btn' href='#' data-activates='download-sra'>Download</a>
	
	  <!-- Dropdown Structure -->
	  <ul id='download-sra' class='dropdown-content'>
	    <li><a href="{% url 'download' id=order.id %}?data=sra&format=original">Original</a></li>
	    <li><a href="{% url 'download' id=order.id %}?data=sra&format=csv">CSV</a></li>
	    <li><a href="{% url 'download' id=order.id %}?data=sra&format=xlsx">XLSX</a></li>
	    <li class="divider"></li>
	    <li><a href="{% url 'download' id=order.id %}?data=combined&format=csv">Combined CSV</a></li>
	    <li><a href="{% url 'download' id=order.id %}?data=combined&format=xlsx">Combined XLSX</a></li>
	  </ul>
	</td>
</tr>
{% endif %}
<tr><th>Biocore</th><td>{% if order.biocore %}<i class="material-icons" style="color:green">check_circle</i>{% else %}<i class="material-icons" style="color:red">close</i>{% endif %}</td></tr>
</table>
<h4>File attachments</h4>

<div id="progress">
	<h5>Upload progress</h5>
    <div class="bar" style="width: 0%;"></div>
</div>
<div id="files">
<table>
{% for f in order.files.all %}
<tr file-id="{{f.id}}"><td>{% if editable %}<i class="file-delete material-icons dp16">delete</i> {% endif %}{{f.formatted_date}}</td><td><a href={{f.file.url}}>{{f.get_filename}}</a></td><td>{{f.formatted_size}}</td></tr>
{% endfor %}
</table>
{% if editable %}
<div class="input-field file-field">
        <div class="btn">
            <span>Upload</span>
            <input id="fileupload" class="btn" type="file" name="file" data-url="/api/submission_files/" multiple>
        </div>
    </div>
{% endif %}
{% include 'partials/modal.html'%}
<script src="/static/vendor/jquery-file-upload/vendor/jquery.ui.widget.js"></script>
<script src="/static/vendor/jquery-file-upload/jquery.iframe-transport.js"></script>
<script src="/static/vendor/jquery-file-upload/jquery.fileupload.js"></script>
<script>




$(document).ready(function(){
	$.ajaxPrefilter(function( options ) {
	    if ( !options.beforeSend) {
	        options.beforeSend = function (xhr) { 
	            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
	        }
	    }
	});
{% if editable %}
	$(function () {
	    $('#fileupload').fileupload({
	        dataType: 'json',
	        done: function (e, data) {
	            $.each(data.result.files, function (index, file) {
	                $('<p/>').text(file.name).appendTo(document.body);
	            });
	        },
	        headers: {
	            'X-CSRFToken': '{{ csrf_token }}'
          	},
          	paramName: 'file',
          	type:'POST',
          	formData:[
          	    {
          	        name: 'submission',
          	        value: '{{order.id}}'
          	    }
          	],
          	done: function (e, data) {
          		$('#files table').append('<tr file-id="'+data.result.id+'"><td><i class="file-delete material-icons dp16">delete</i> '+data.result.date+'</td><td><a href="'+data.result.file+'">'+data.result.filename+'</a></td><td>'+data.result.size+'</td></tr>');
          		console.log('file',data.result);
          		Materialize.toast(data.result.filename+' uploaded',3000);
          	    // data.result
          	    // data.textStatus;
          	    // data.jqXHR;
          	},
          	fail: function (e, data) {
          		console.log('file',data.files);
          		$.each(data.files,function(index,file){Materialize.toast('Upload failed for '+file.name,5000,'error')});
          		//$.toast({text:'Upload failed for '+data.result.filename,position:'top-center',icon:'error'})
          	    // data.result
          	    // data.textStatus;
          	    // data.jqXHR;
          	},
          	progressall: function (e, data) {
          		$('#progress').show();
          		var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#progress .bar').css(
                    'width',
                    progress + '%'
                );
            }
	    });
	});
	$('select[name=status]').change(function(data){
		$.post('/api/orders/{{order.id}}/update_status/',{status:this.value,email:$('[name=send_email]').is(":checked")?true:null},function(data){Materialize.toast(data.message,5000);});
	});
	function delete_file(id){
		$.ajax('/api/submission_files/'+id+'/',{type: 'DELETE'})
		.done(function(){
			$('[file-id='+id+']').closest('tr').remove();
			Materialize.toast("File deleted",5000);
		})
		.fail(function(){
			Materialize.toast("Error deleting file",5000,'error');
		});
	}
	$( "#files table" ).on( "click",".file-delete", function() {
	  	if (confirm('Are you sure you want to delete this file?'))
	  		delete_file($( this ).closest('tr').attr('file-id'));
	});
{% endif %}
{% if order.samplesheet %}
	var samplesheet = {{order.samplesheet.to_json|safe}};
	var sample_modal = new spreadsheet_modal(samplesheet,{title:'Samplesheet'});
	$('#view_samples').click(function(){
		sample_modal.open();
	});
{% endif %}
{% if order.sra_samplesheet %}
	var sra_samplesheet = {{order.sra_samplesheet.to_json|safe}};
	var sra_modal = new spreadsheet_modal(sra_samplesheet,{title:'SRA Samplesheet'});
	$('#view_sra').click(function(){
		sra_modal.open();
	});
{% endif %}
	
});

</script>


{% endblock %}