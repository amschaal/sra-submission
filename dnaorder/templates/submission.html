{% extends 'base.html' %}
{% load material_form %}
{% block content %}
<style>
.modal{
  width:90%;
  max-height:90%;
}
.bar {
    height: 18px;
    background: green;
}
#progress{
	display:none;
}
#files table td{
	padding: 5px;
}
.file-delete,.action{
	cursor: pointer;
}
.toast.error{
background-color:#cc0000;
}
.card .card-title{
  line-height: 24px;
  font-size: 16px;
}
.card .card-content{
  padding: 12px;
}
.note textarea{
  background-color: white;
}
.note label{
color: white;
}
</style>
{% if confirmed %}
<h3>Submission confirmed!</h3>
<h5>The DNA Technologies Core has been notified and will be reviewing it shortly.  You may upload any additional files below, or <a  href="{% url 'update_submission' id=submission.id %}">Modify</a> the submission details.  Once the submission is being processed, you will no longer be able to make any changes.  For future reference, you can view your order at the followign URL:</h5>
{{BASE_URI}}{{submission.get_absolute_url}}
{% elif submitted %}
<h3>Submission complete! {% if editable %}<a class="btn right" href="{% url 'update_submission' id=submission.id %}">Modify</a>{% endif%}</h3>
<p>Communications regarding the submission will be sent to {{submission.email}}.  Please check your email and click the link to confirm the submission.  To inquire on the status of the submission, contact dnatech@ucdavis.edu.</p>
<p>You may now upload Bioanalyzer traces, or any other required files <a href="#files">below</a>.</p>
{% else %}
<h3>Submission {{submission.id}} {% if editable %}<a class="btn right" href="{% url 'update_submission' id=submission.id %}">Modify</a>{% endif%}</h3>
{% endif %}



<table>

{% if status_form %}
<tr>
	<th>Status</th>
	<td>
		<form id="status-form">
			{% form form=status_form %}{% part form.status label %}{% endpart %}{% endform %}
		</form>
	</td>
</tr>
{% else %}
<tr><th>Status</th><td>{{submission.status.name}}</td></tr>
{% endif %}
<tr><th>Submitted</th><td>{{submission.submitted}}</td></tr>
<tr><th>Updated</th><td>{{submission.updated}}</td></tr>
<tr><th>Name</th><td>{{submission.name}}</td></tr>
<tr><th>Email</th><td>{{submission.email}}</td></tr>
<tr><th>Phone</th><td>{{submission.phone}}</td></tr>
<tr><th>PI</th><td>{{submission.pi_name}}</td></tr>
<tr><th>PI email</th><td>{{submission.pi_email}}</td></tr>
<tr><th>Institute</th><td>{{submission.institute}}</td></tr>
{% if submission.notes %}<tr><th>Notes</th><td>{{submission.notes}}</td></tr>{% endif %}
<tr><th>Type</th><td>{{submission.type}}</td></tr>
<tr><th># Samples</th><td><span title="{% for s in submission.sample_ids %}{{s}}{% if not forloop.last %}, {% endif %}{% endfor %}">{{submission.sample_ids|length}}</span> </td></tr>
<tr>
	<th>Samplesheet</th>
	<td>
	<a id="view_samples" class="modal-trigger btn" href="#samples_modal">View</a>
  <!-- Dropdown Trigger -->
  <a class='dropdown-button btn' href='#' data-activates='download-samples'>Download</a>

  <!-- Dropdown Structure -->
  <ul id='download-samples' class='dropdown-content'>
    <li><a href="{% url 'download' id=submission.id %}?data=samples&format=original">Original</a></li>
    <li><a href="{% url 'download' id=submission.id %}?data=samples&format=csv">CSV</a></li>
    <li><a href="{% url 'download' id=submission.id %}?data=samples&format=xlsx">XLSX</a></li>
    <!-- 
    <li><a href="#!">two</a></li>
    <li class="divider"></li>
    <li><a href="#!">three</a></li>
    <li><a href="#!"><i class="material-icons">view_module</i>four</a></li>
	 -->
  </ul>
	</td>
</tr>
{% if submission.sra_form %}
<tr><th>SRA samplesheet</th>
	<td>
	<a id="view_sra" class="modal-trigger btn" href="#sra_modal">View</a>
	  <!-- Dropdown Trigger -->
	  <a class='dropdown-button btn' href='#' data-activates='download-sra'>Download</a>
	
	  <!-- Dropdown Structure -->
	  <ul id='download-sra' class='dropdown-content'>
	    <li><a href="{% url 'download' id=submission.id %}?data=sra&format=original">Original</a></li>
	    <li><a href="{% url 'download' id=submission.id %}?data=sra&format=csv">CSV</a></li>
	    <li><a href="{% url 'download' id=submission.id %}?data=sra&format=xlsx">XLSX</a></li>
	    <li class="divider"></li>
	    <li><a href="{% url 'download' id=submission.id %}?data=combined&format=csv">Combined CSV</a></li>
	    <li><a href="{% url 'download' id=submission.id %}?data=combined&format=xlsx">Combined XLSX</a></li>
	  </ul>
	</td>
</tr>
{% endif %}
<tr><th>Analysis by<br>Bioinformatics Core</th><td>{% if submission.biocore %}<i class="material-icons" style="color:green">check_circle</i>{% else %}<i class="material-icons" style="color:red">close</i>{% endif %}</td></tr>
</table>
<h4>File attachments</h4>

<div id="progress">
	<h5>Upload progress</h5>
    <div class="bar" style="width: 0%;"></div>
</div>
<div id="files">
<table>
{% for f in submission.files.all %}
<tr file-id="{{f.id}}"><td>{% if editable %}<i class="file-delete material-icons dp16">delete</i> {% endif %}{{f.formatted_date}}</td><td><a href={{f.file.url}}>{{f.get_filename}}</a></td><td>{{f.formatted_size}}</td></tr>
{% endfor %}
</table>
{% if editable %}
<div class="input-field file-field">
        <div class="btn">
            <span>Upload</span>
            <input id="fileupload" class="btn" type="file" name="file" data-url="/api/submission_files/" multiple>
        </div>
    </div>
{% endif %}
<div style="clear:both"></div>
{% verbatim %}
<div ng-controller="NotesCtrl as notes">
<h4>Notes<button class="btn right" ng-click="notes.newNote();">Add Note</button></h4>
	<div class="{{notes.getClasses(n)}} card horizontal note" ng-repeat="n in notes.notes | orderBy:'-id'">
	<div class="card-stacked">
        <div class="card-content white-text" ng-if="n.id && !n.edit">
          <span class="card-title"><i ng-if="n.can_modify" ng-click="notes.deleteNote(n)" class="material-icons tiny action">delete</i> {{n.created|date:"short"}} - {{notes.getTypeText(n)}}<span class="right"><i class="material-icons tiny">person</i> {{n.user}}</span></span>
          <p>{{n.text}} <i ng-if="n.can_modify" class="material-icons tiny action" ng-click="n.edit=true;">edit</i></p>
        </div>
        <div class="card-content white-text" ng-if="!n.id">
          <form>
          <p><textarea ng-model="n.text"></textarea>{{n}}</p>
          <div class="left">
          	<label><input type="checkbox" ng-model="n.public" ng-true-value="false" ng-false-value="true"/><span>Private</span></label> <label ng-if="n.public"><input type="checkbox" ng-model="n.emails" ng-true-value="['{{notes.submission.email}}']" ng-false-value=""/><span>Email</span></label>
          </div>
      	<div class="right"><button class="btn red lighten-1 btn-small" ng-click="notes.deleteNote(n)">Delete</button> <button class="btn btn-small" ng-click="notes.saveNote(n)">Save</button></div>
          </form>
        </div>
        <div class="card-content white-text" ng-if="n.edit">
          <form>
          <p><textarea ng-model="n.text"></textarea></p>
          <div class="left">
          	<label><input type="checkbox" ng-model="n.public" ng-true-value="false" ng-false-value="true"/><span>Private</span></label>
          </div>
          <div class="right"><button class="btn" ng-click="notes.saveNote(n)">Save</button></div>
          </form>
        </div>
	</div>
	</div>
</div>
{% endverbatim %}
{% include 'partials/modal.html'%}
<script src="/static/vendor/jquery-file-upload/vendor/jquery.ui.widget.js"></script>
<script src="/static/vendor/jquery-file-upload/jquery.iframe-transport.js"></script>
<script src="/static/vendor/jquery-file-upload/jquery.fileupload.js"></script>
<script>




$(document).ready(function(){
	$.ajaxPrefilter(function( options ) {
	    if ( !options.beforeSend) {
	        options.beforeSend = function (xhr) { 
	            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
	        }
	    }
	});
{% if editable %}
	$(function () {
	    $('#fileupload').fileupload({
	        dataType: 'json',
	        done: function (e, data) {
	            $.each(data.result.files, function (index, file) {
	                $('<p/>').text(file.name).appendTo(document.body);
	            });
	        },
	        headers: {
	            'X-CSRFToken': '{{ csrf_token }}'
          	},
          	paramName: 'file',
          	type:'POST',
          	formData:[
          	    {
          	        name: 'submission',
          	        value: '{{submission.id}}'
          	    }
          	],
          	done: function (e, data) {
          		$('#files table').append('<tr file-id="'+data.result.id+'"><td><i class="file-delete material-icons dp16">delete</i> '+data.result.date+'</td><td><a href="'+data.result.file+'">'+data.result.filename+'</a></td><td>'+data.result.size+'</td></tr>');
          		console.log('file',data.result);
          		Materialize.toast(data.result.filename+' uploaded',3000);
          	    // data.result
          	    // data.textStatus;
          	    // data.jqXHR;
          	},
          	fail: function (e, data) {
          		console.log('file',data.files);
          		$.each(data.files,function(index,file){Materialize.toast('Upload failed for '+file.name,5000,'error')});
          		//$.toast({text:'Upload failed for '+data.result.filename,position:'top-center',icon:'error'})
          	    // data.result
          	    // data.textStatus;
          	    // data.jqXHR;
          	},
          	progressall: function (e, data) {
          		$('#progress').show();
          		var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#progress .bar').css(
                    'width',
                    progress + '%'
                );
            }
	    });
	});
	$('select[name=status]').change(function(data){
		$.post('/api/submissions/{{submission.id}}/update_status/',{status:this.value,email:$('[name=send_email]').is(":checked")?true:null},function(data){Materialize.toast(data.message,5000);});
	});
	function delete_file(id){
		$.ajax('/api/submission_files/'+id+'/',{type: 'DELETE'})
		.done(function(){
			$('[file-id='+id+']').closest('tr').remove();
			Materialize.toast("File deleted",5000);
		})
		.fail(function(){
			Materialize.toast("Error deleting file",5000,'error');
		});
	}
	$( "#files table" ).on( "click",".file-delete", function() {
	  	if (confirm('Are you sure you want to delete this file?'))
	  		delete_file($( this ).closest('tr').attr('file-id'));
	});
{% endif %}
{% if submission.samplesheet %}
	var samplesheet = {{submission.samplesheet.to_json|safe}};
	var sample_modal = new spreadsheet_modal(samplesheet,{title:'Samplesheet'});
	$('#view_samples').click(function(){
		sample_modal.open();
	});
{% endif %}
{% if submission.sra_samplesheet %}
	var sra_samplesheet = {{submission.sra_samplesheet.to_json|safe}};
	var sra_modal = new spreadsheet_modal(sra_samplesheet,{title:'SRA Samplesheet'});
	$('#view_sra').click(function(){
		sra_modal.open();
	});
{% endif %}
	
});

</script>

<script>
var app = angular.module('main', ['Models']).
        controller('NotesCtrl', function($scope, Note, Submission,$http) {
            var self = this;
        	self.notes = Note.query({submission:'{{submission.id}}'});
        	self.submission = Submission.get({id:'{{submission.id}}'});
        	self.newNote = function(){
        				self.notes.push(
	        				new Note({
		        					type:'NOTE',
		        					submission:'{{submission.id}}',
		        					created_by:{{request.user.id}},
		        					emails: null,
		        					public: true
	        					})
        				);
        	};
        	self.saveNote = function(note){
        		var method = note.id ? '$save' : '$create';
        		note[method]()
        	};
        	self.deleteNote = function(note){
        		if (!note.id)
        			self.notes.splice(self.notes.indexOf(note),1);
        		else if (confirm('Are you sure you want to delete this note?'))
        			note.$delete(function(){self.notes.splice(self.notes.indexOf(note),1);Materialize.toast('Note deleted',5000);},function(){Materialize.toast('Error deleting note',5000);});
        	};
        	self.getClasses= function(note){
        		if (!note.public)
        			return 'red lighten-1';
        		if (note.type == 'NOTE')
        			return 'green darken-1';
        		if (note.type == 'LOG')
        			return 'blue-grey';
        	};
        	self.getTypeText = function(note){
        		if (!note.public)
        			return 'Note (private)';
        		if (note.type == 'NOTE')
        			return 'Note';
        		if (note.type == 'LOG')
        			return 'Log';
        	}
        });
app.config(function($resourceProvider) {
	  $resourceProvider.defaults.stripTrailingSlashes = false;
	});
app.config(['$httpProvider', function($httpProvider) {
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
}]);
    		
</script>

{% endblock %}