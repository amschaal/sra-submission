{% extends 'base.html' %}
{% load material_form %}
{% block content %}
<style>
.visualize_errors{
	font-size: 150%;
}
50% {
  font-size: 200%;
}
.blow-up {
  animation-duration: 1s;
  animation-name: blowup;
  padding: 1px;
  font-size: 16px;
}

@keyframes blowup {
  from {
    font-size: 100%; 
  }

  50% {
    font-size: 150%;
  }

  to {
    font-size: 100%;
  }
}
.errors .error{
  display:block;
}
.modal{
  width:90%;
  max-height:90%;
}
#id_biocore_container label span{
  font-size: 16pt;
  margin-top:10px;
  margin-bottom:10px;
}
</style>
<div class="card-panel" ng-controller="FormCtrl as ctrl">

<form enctype="multipart/form-data" novalidate method="POST" action=".">
<h4>Submission Form</h4>
<div id="example1" class="hot handsontable htRowHeaders htColumnHeaders"></div>
{% verbatim %}
{{submission}}
{% endverbatim %}
{% csrf_token %}
{% form form=form %}{% endform %}
<button class="btn waves-effect waves-teal">Submit</button>
</form>
<h5>*You will be able to upload Bioanalyzer traces and other files once the form is submitted.</h5>
</div>
<div style="display:none">
{% for type in submission_types %}<span id="form_{{type.id}}">Download template: <a class="order_form" href="{{type.form.url}}" title="{{type.description}}">{{type.name}}</a></span>{% endfor %}
</div>

{% include 'partials/modal.html'%}
<script src="https://docs.handsontable.com/4.0.0/components/handsontable/dist/handsontable.full.js"></script>
<link type="text/css" rel="stylesheet" href="https://docs.handsontable.com/4.0.0/components/handsontable/dist/handsontable.full.min.css">
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.5.2/ajv.bundle.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/4.1.7/ajv.bundle.js"></script>
<script src="/static/vendor/hot-schema/example_schema.js"></script>
<script src="/static/vendor/hot-schema/hotschema.js"></script>
<script src="/static/js/directives/angularhotschema.js"></script>
<script>

{% if form.samplesheet %}
	var samplesheet = {{form.samplesheet.to_json|safe}};
{% endif %}
{% if form.sra_samplesheet %}
	var sra_samplesheet = {{form.sra_samplesheet.to_json|safe}};
{% endif %}

function change_type(el){
	var id = $(this).val();  
	/*
	if (!id)
		$('#template_header').hide();
	else{
		$('#template_header').show();
		$('.order_form').hide();
	*/
	if(id)
		$('#sample_form_help').html($('<span class="blow-up"></span>').html($('#form_'+id).clone()));
	else
		$('#sample_form_help').html('<span class="blow-up">Please select a submission type in order to generate a template.</a').addClass('blow-up');
}

$(document).ready(function(){
	var hst = new HotSchemaTable(document.getElementById('example1'), example_schemas.veggie);
	$('.modal').modal();
	$( "select[name=type]").change(change_type);
	$( "select[name=type]").trigger('change');
	//$('#id_sample_form_container.has-error').parent().append('<a id="visualize_sample_errors" href="#samples_modal">Visualize Errors</a>');
	//$('#id_sra_form_container.has-error').parent().append('<a id="visualize_sra_errors" href="#sra_modal">Visualize Errors</a>');
	{% if form.samplesheet %}
	{% if form.submission_samplesheet %}
	var samples_modal = new spreadsheet_modal([{header:'Submission',data:{{form.submission_samplesheet.to_json|safe}},list:false},{header:'Samples',data:samplesheet}],{error:true,title:'Samplesheet errors',body:'<p>Errors in <span style="color:red;">red</span>.  Hover over cells to view error details.</p>'});
	{% else %}
	var samples_modal = new spreadsheet_modal([{header:'Samples',data:samplesheet}],{error:true,title:'Samplesheet errors',body:'<p>Errors in <span style="color:red;">red</span>.  Hover over cells to view error details.</p>'});
	{% endif %}
	
	
	//var samples_modal = new spreadsheet_modal(samplesheet,{error:true,title:'Samplesheet errors',body:'<p>Errors in <span style="color:red;">red</span>.  Hover over cells to view error details.</p>'});
	$('input[name=sample_form]').parent().parent().find('.visualize_errors').click(function(){
		samples_modal.open();
	});
	{% endif %}
	{% if form.sra_samplesheet %}
	var sra_modal = new spreadsheet_modal([{header:'',data:samplesheet}],{title:'SRA errors',body:'<p>Errors in <span style="color:red;">red</span>.  Hover over cells to view error details.</p>'});
	//var sra_modal = new spreadsheet_modal(sra_samplesheet,{error:true,title:'SRA errors',body:'<p>Errors in <span style="color:red;">red</span>.  Hover over cells to view error details.</p>'});
	$('input[name=sra_form]').parent().parent().find('.visualize_errors').click(function(){
		sra_modal.open();
	});
	{% endif %}
});

</script>

<script>
var app = angular.module('main', ['Models','angularhotschema']).
        controller('FormCtrl', function($scope, $http) {
            var self = this;
            $scope.$watch('submission.type', function() {
                //alert('hey, type has changed!');
            });
        });
app.config(function($resourceProvider) {
	  $resourceProvider.defaults.stripTrailingSlashes = false;
	});
app.config(['$httpProvider', function($httpProvider) {
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
}]);
    		
</script>
{% endblock %}